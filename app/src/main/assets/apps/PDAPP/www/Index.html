<!doctype html>
<html>

	<head>
		<title>e康云健康管理</title>
		<meta charset="utf-8">
		<meta name="format-detection" content="telephone=no" />
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />

		
		<script>
			
			
		</script>
		<link href="css/lib/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/lib/huimin.css">
		<link rel="stylesheet" type="text/css" href="css/lib/CSSRESET.css">
		<link rel="stylesheet" type="text/css" href="css/common2.css">
		<link rel="stylesheet" type="text/css" href="css/index.css">
		<link rel="stylesheet" type="text/css" href="css/indexNew.css">
        <link rel="stylesheet" type="text/css" href="css/topMsgTip.css" rel="stylesheet" />
        
		<style type="text/css">
			[v-cloak] {
				display: none;
			}
			
			p {
    color:white;
}
			.circle {
				display: block;
				float: left;
				padding: 1px;
				margin-left: 2px;
				width: 15%;
			}
			
			.circles-text {
				margin-top: -6px;
			}
			
			a:link {
				text-decoration: none;
				color: #8295B3;
			}
			
			a:visited {
				text-decoration: none;
			}
			
			a:hover {
				text-decoration: none;
			}
			
			a:active {
				text-decoration: none;
			}
			
						.list_3{ margin:0.8rem 0; padding:0.5rem 0.3rem; font-size: 0; background: #fff; }
			.list_3 li{ /*width:33.3333%;*/width:50%; display: inline-block; padding:0.3rem;  position: relative; box-sizing: border-box; }
			.list_3 a{ display: block; }
			.list_3 img{  width:100%; border-radius: 0.5rem;}
			.list_3 div{ width:100%; height: 100%; position: absolute; top:0; left:0; padding:1.0rem; box-sizing: border-box; }
			.list_3 h5{ font-size: 1.4rem; color:#222; font-weight: bold; margin-bottom: 0.4rem; }
			.list_3 h6{ font-size: 1.1rem; color:#777; }
			.list_3 p{ font-size: 1.1rem; position: absolute; bottom:1rem; }
			.list_3 em{ font-size: 1.6rem; padding-right:0.6rem; color:inherit; }
			.list_3 strong{ font-size: 1.8rem; padding-right:0.6rem; color:inherit; }
			
		</style>
	</head>

	<body>
		<div class="_container clear" id="bodyinfo">
			<!--<div class="hpn_top_container" style="display:none;top:0px;">
				<span class="hpn_top_icon">
		<img class="rms_img" src="img/xixi.png">
	</span>
				<span class="hpn_top_desc" @click="GoTask">您有健康任务要完成哦,去完成!</span>
			</div>-->
			<article class="wrapper" v-cloak>
				<div class="main">

					<div class="msg">
						<div class="msg_left">
							<img v-bind:src="HeadPic" alt="" id="btnFamily" />
							<div>
								<a href="javascript:;" v-cloak>{{UserName}}</a>
								<p v-cloak>{{NickName}}</p>
							</div>
						</div>

					</div>
					<!-- msg -->


					<!-- title -->

					<div class="welcome">e康欢迎您!</div>

					<div class="gray">
						<div class="funcs">
							<ul class="ul_funcs clearfix">
								<li>
								<a href="javascript:clicked('member/MemberDataIndex.html', 'MemberDataIndex.html', 'slide-in-left', '健康数据');">
									<span><img src="img/index_func_1.png" alt=""></span>
									<p>健康数据</p>
								</a>
							</li>
								<li>
								<a href="javascript:clicked('member/UploadCaseFiles.html', 'UploadCaseFiles.html', 'slide-in-left', '病历上传');">
									<span><img src="img/index_func_2.png" alt=""></span>
									<p>病历上传</p>
								</a>
							   </li>
							   
							   	<li>
								<a href="javascript:clicked('member/TestMenu.html','TestMenu.html','zoom-fade-out','健康评测');">
									<span><img src="img/index_link_6.png" alt=""></span>
									<p>健康自测</p>
								</a>
							   </li>
							   
							   <li>
								<a @click="PowerCardActive(4);">
									<span><img src="img/index_func_6.png" alt=""></span>
									<p>健康评估</p>
								</a>
							  </li>
							  <li>
								<a href="javascript:clicked('member/MyProjectRecord.html','TestMenu.html','zoom-fade-out','健康方案');">
									<span><img src="img/index_func_7.png" alt=""></span>
									<p>健康方案</p>
								</a>
							  </li>
								<li>
								<a href="javascript:clicked('member/AskedQuestionRecord.html','AskedQuestionRecord.html','zoom-fade-out','百问百答');">	
									<span><img src="img/index_link_5.png" alt=""></span>
									<p>百问百答</p>
								</a>
							  </li>
								<li>
								<a href="javascript:clicked('member/CaseShareRecord.html','CaseShareRecord.html','zoom-fade-out','案例分享');">	
									<span><img src="img/index_link_7.png" alt=""></span>
									<p>案例分享</p>
								</a>
							  </li>

							   <li>
									<a href="javascript:clickedNoHead('member/DeviceList.html', 'DeviceList.html', 'slide-in-left');">
										<span><img src="img/_index_menu_8.png" alt=""></span>
										<p>健康监测</p>
									</a>
								</li>
								

						
								
							</ul>
						</div>
						<!-- funcs -->
					<div class="daily" v-cloak v-show="CardPowerActive==1" @click="GoTask2">
						<h3>我的健康日志</h3>
						<h4>今天快完成了哦!加油</h4>

						<div class="data" v-cloak>
							<!--  data-value 值 为 0-100 -->
							<div class="cprogress" v-cloak>

								<div id="circles1" class="mui-icon" v-cloak></div>
								<span v-cloak>运动</span>

							</div>

							<div class="cprogress" v-cloak>

								<div id="circles2" class="mui-icon"></div>
								<span>膳食</span>

							</div>

							<div class="cprogress" v-cloak>

								<div id="circles3" class="mui-icon"></div>
								<span>营养素</span>

							</div>

							<div class="cprogress" v-cloak>

								<div id="circles4" class="mui-icon"></div>
								<span>监测</span>

							</div>
						</div>

					</div>
					<div class="news" @click=GoTaskWelcome() v-show="CardPowerActive==0" v-cloak>

						<div><img src="img/banner8s.jpg" alt="" width=100%/></div>

					</div>
						<div class="news">
							<h2 class="cm_h2">
                            <span>健康资讯</span>
                            <a href="javascript:clicked('member/NewsIndex.html','NewsIndex.html','slide-in-right','健康资讯');">更多</a>
                        </h2>

							<ul class="ul_news" v-cloak>
								<li v-for="(Item,index) in NewsList" @click="ShowNewsContent(Item.NewsId)">
									<div><img :src="Item.NewsPic" alt="" /></div>
									<div>
										<h4 v-cloak>{{Item.NewsTitle}}</h4>
										<p>
											<a href="javascript:;" v-cloak>阅读 {{Item.click_number}}</a>·
											<a href="javascript:;" v-cloak>{{Item.pubtime}}</a>
										</p>
									</div>
								</li>

							</ul>
						</div>
						<!-- news -->
<div style="height: 50px;"></div>
					</div>
					<!-- chats -->
				</div>
				
			</article>
			
			<!-- wrapper End -->

		</div>
	</body>
	<script src="js/lib/mui.min.js"></script>
		<script src="js/lib/util.js"></script>
		<script src="js/index.js" type="text/javascript"></script>
	<script src="js/lib/jquery-2.1.3.min.js"></script>

	<script src="js/lib/vue20.min.js" type="text/javascript"></script>
	<script src="js/lib/hui.js" type="text/javascript"></script>
	<script src="js/public.js" type="text/javascript"></script>
		<script src="js/lib/axios.min.js"></script>
	<script src="js/lib/qs.js"></script>
		<script src="js/circles.js"></script>
	<script src="js/taskDataCircles.js"></script>
	<script type="text/javascript">
		var domainUrl = GetMvcApiDomain();
		var mallDomainUrl = GetMallApiDomain();
				var child1 = document.getElementById('circles1');
		var child2 = document.getElementById('circles2');
		var child3 = document.getElementById('circles3');
		var child4 = document.getElementById('circles4');
		
		
		var menu, _self, _main;

		mui.init();

		function plusReadyDo() {

			mui.plusReady(function() {
				var launchFlag = plus.storage.getItem("launchFlag");
				if(!launchFlag){
					plus.webview.open('start.html', 'new', {}, 'none', 0);
					
                    setTimeout(function() {
					plus.navigator.closeSplashscreen();
					}, 200);
				}
				else{
					
				
                mui.os.ios&&plus.navigator.setFullscreen(true);  
				var objuser = JSON.parse(plus.storage.getItem('user'));

				if(objuser == undefined || objuser == null || objuser == '') {
					
					plus.webview.open('login.html', 'new', {}, 'none', 0);
					
                    setTimeout(function() {
					plus.navigator.closeSplashscreen();
					}, 200);
				} else {

					vum.UserName = objuser.UserName;
					vum.NickName=objuser.NickName;
					vum.HeadPic=objuser.HeadPic;
					
					
					var self = plus.webview.currentWebview();




					
					

					

					// 创建子webview窗口 并初始化
					var aniShow = {};
					util.initSubpage(aniShow);

					var nview = plus.nativeObj.View.getViewById('tabBar'),
						activePage = plus.webview.currentWebview(),
						targetPage,
						subpages = util.options.subpages,
						pageW = window.innerWidth,
						currIndex = 0;

					/**
					 * 根据判断view控件点击位置判断切换的tab
					 */
					nview.addEventListener('click', function(e) {
						var clientX = e.clientX;
						if(clientX > 0 && clientX <= parseInt(pageW * 0.25)) {
							currIndex = 0;
						} else if(clientX > parseInt(pageW * 0.25) && clientX <= parseInt(pageW * 0.55)) {
							currIndex = 1;
						} else if(clientX > parseInt(pageW * 0.55) && clientX <= parseInt(pageW * 0.8)) {
							currIndex = 2;
						} else {
							currIndex = 3;
						}
						// 匹配对应tab窗口	
						if(currIndex > 0) {
							targetPage = plus.webview.getWebviewById(subpages[currIndex - 1]);
						} else {
							targetPage = plus.webview.currentWebview();
						}

						if(targetPage == activePage) {
							return;
						}
						
                        
						if(currIndex == 1) {
							targetPage.evalJS("plusReady();");
						}

						if(currIndex == 2) {

								targetPage.evalJS('plusReady()');
	
							
						}
						if(currIndex == 3) {
							targetPage.evalJS('isPlusReady()');
						}
						//底部选项卡切换
						util.toggleNview(currIndex);
						console.log(subpages);

						// 子页面切换
						util.changeSubpage(targetPage, activePage, aniShow);
						//更新当前活跃的页面
						activePage = targetPage;

					});





					//	dblBackQuit();				

					vum.getUserInfo(vum.UserName);
					vum.getTaskData(vum.UserName);
					vum.getNewsRecommendList('15', '10');

                    plus.navigator.closeSplashscreen();
				}
			 }

			});

		}

		plusReadyDo();

		var vum = new Vue({
			el: '#bodyinfo',
			data: function() {
				return {
					UserName: "",
					NickName: "",
					HeadPic: "",
					CardPowerActive: 0,
					Quality: '',
					CityAQI: '',
					TopicList: [],
					NewsList: []
				}
			},
			created: function() {

			},
			mounted: function() {

				this.$nextTick(function() {
					that=this;
					setTimeout(function() {
						that.closeTopMsg();
					}, 5000);
				})

			},

			methods: {
				getTopicList: function(topcount) {
					var that = this;
					$.ajax({
						url: domainUrl + "api/Topic/getTopicList",
						type: 'get',
						dataType: "json",
						data: {
							topcount: topcount
						},
						beforeSend: function() {
							hui.h5Loading(false, '加载中...', {
								round: 2,
								padding: '20px',
								textalign: 'right'
							});
						},
						success: function(data) {
							$.each(data, function(i, j) {

								that.TopicList.push({
									number: (i + 1),
									topicId: j.Id,
									PostUser: j.UserName,
									headpic: j.headpic,
									title: j.title,
									CommentCount: j.CommentCount,
									LikeCount: j.LikeCount,
									PostTime: getDateDiff(getDateTimeStamp(j.posttime))
								});
							});
						},
						error: function() {
							hui.h5Loading(true);
							plus.nativeUI.toast("网络错误，请稍后再试");
						},
						complete: function(data, textStatus) {
							hui.h5Loading(true);
						}
					})

				},

				getUserInfo: function(username) {
					
					var objuser = JSON.parse(plus.storage.getItem('user'));
					this.UserName = objuser.UserName;
					this.NickName = objuser.NickName;
					this.HeadPic = objuser.HeadPic;
					
						var that = this;
						axios.get(domainUrl + 'api/MemberOperate/getUserInfoByCode', {
								params: {
									UserName: username,
								}
							})
							.then(function(response) {

									that.getUserAccount(username,response.data.userbs)


							})
							.catch(function(response) {
								console.log(response);

							});
					},
				getUserAccount: function(UserName,userbs) {
					var that = this;
					$.ajax({
						url: mallDomainUrl + "api/Member/getUserAccount",
						type: 'get',
						dataType: "json",
						data: {
							UserName: UserName
						},
						beforeSend: function() {
							hui.loading('数据加载中');
						},
						success: function(data) {
							if(data.code == '200') {
								if (userbs>=5 && data.cardPower==0){
                  			     that.SendCardActiveAuto(username,'2');
                  		         }
								else{
									
								
								that.CardPowerActive = data.cardPower;
								plus.storage.setItem('CardPowerActive', data.cardPower);
                                if (that.CardPowerActive==1){
                                	that.showTopMsg();
                                }
                               }
								
							console.log(that.CardPowerActive);
								
							}
						},
						error: function() {
							hui.closeLoading();
							hui.toast("网络错误，请稍后再试");
						},
						complete: function(data, textStatus) {
							hui.closeLoading();
						}
					})

				},
				
				SendCardActiveAuto: function (UserName, OppState) {
                var that = this;

                axios.post(mallDomainUrl + 'api/CardPower/PostSendCardActiveAuto', Qs.stringify({
				user_name: UserName,
                oppstate:OppState
				}))
                
                .then(function (response) {
                  	if(response.data.code=='200'){
                  		that.CardPowerActive=1;
								plus.storage.setItem('CardPowerActive', that.CardPowerActive);
                                if (that.CardPowerActive==1){
                                	that.showTopMsg();
                                }
                  	}

                })
                .catch(function (response) {
                  console.log(response);
                 });

            },
            
            getTaskData: function(UserName) {

					var that = this;
					axios.get(domainUrl + 'api/HItemRecord/getInsRecordNewData', {
							params: {
								UserName: UserName
							}
						})
						.then(function(response) {

							if(response.data.code == "200") {

								//hui.loading('数据加载中');

								that.SportVal = 85;
								that.FoodVal = response.data.BPLow;
								that.MedVal = response.data.BPPR;
								that.Monitor = response.data.BPPR;

								that.showItemData('Sport', that.SportVal, child1, getColor, getCircle);
								that.showItemData('Food', that.FoodVal, child2, getColor, getCircle);
								that.showItemData('Med', that.MedVal, child3, getColor, getCircle);
								that.showItemData('Monitor', that.MedVal, child4, getColor, getCircle);

								//hui.loading(false, true);
							}

						})

						.catch(function(response) {
							that.IsShow = 0;
							console.log(response);
						});

				},
            	showItemData: function(iType, insVal, circleId, FuncColor, FunCircle) {

					if(insVal != '' && insVal != null && insVal != undefined) {
						var colorVal = FuncColor(iType);
						var maxVal = getCircleMaxValue(iType);

						FunCircle(circleId, insVal, colorVal, maxVal);

					}

				},
            	showTopMsg: function() {
					if (this.CardPowerActive==1){
						$(".hpn_top_container").slideDown(300);
					}
					
				},
				closeTopMsg: function() {
					$(".hpn_top_container").slideUp(500);
				},
            	GoTask: function() {
            		var parm = {
						"FromUrl": "MsgTo"
					}
					clickedNoHeadParm('member/HealthTask.html', 'member/HealthTask.html', 'zoom-fade-out', parm);
				},
				GoTask2: function() {
					clickedNoHead('member/HealthTask.html', 'HealthTask.html', 'slide-in-left');
				},
				getNewsRecommendList: function(newsClass, topcount) {
					var that = this;
					$.ajax({
						url: domainUrl + "api/News/getNewsRecommendList",
						type: 'get',
						dataType: "json",
						data: {
							newsClass: newsClass,
							topcount: topcount
						},
						beforeSend: function() {
							hui.h5Loading(false, '加载中...', {
								round: 2,
								padding: '20px',
								textalign: 'right'
							});
						},
						success: function(data) {
							var summary = "";
							$.each(data, function(i, j) {
								summary = j.summary + '...';
								var pubtime = getDateDiff(getDateTimeStamp(j.create_date));
								that.NewsList.push({
									number: (i + 1),
									NewsId: j.Id,
									NewsTitle: j.title,
									NewsContent: j.content,
									summary: summary,
									NewsPic: j.img_src,
									pubtime: pubtime,
									CommentCount: j.CommentCount,
									LikeCount: j.LikeCount,
									FollowCount: j.FollowCount,
									click_number: j.click_number
								});

							});
						},
						error: function() {
							hui.h5Loading(true);
							plus.nativeUI.toast("网络错误，请稍后再试");
						},
						complete: function(data, textStatus) {
							hui.h5Loading(true);
						}
					})

				},

				getIsLikeSet: function(topicId) {
					var res = 0;
					var that=this;
					$.ajax({
						url: domainUrl + "api/Topic/getTopicIsSetLike",
						type: 'get',
						dataType: "json",
						async: false,
						data: {
							UserName: that.UserName,
							TopicId: topicId
						},
						success: function(data) {
							if(data.code == "200") {
								if(data.isHave >= "1") {
									res = '1';
								}
							}
						},
						error: function() {
							plus.nativeUI.toast("读取数据错误，请稍后再试");
							return false;
						}
					})

					return res;

				},

				SetLikePost: function(topicId) {
					var res = this.getIsLikeSet(topicId);
					if(res == '0') {
						var that=this;
						$.ajax({
							url: domainUrl + "api/Topic/GetTopicSetLike",
							type: 'get',
							dataType: "json",
							data: {
								UserName: that.UserName,
								TopicId: topicId
							},
							success: function(data) {
								if(data.code == "200") {
									plus.nativeUI.toast("点赞");
								}
							},
							error: function() {
								plus.nativeUI.toast("网络错误，请稍后再试");
							}
						})
					} else {
						plus.nativeUI.toast("已点赞");
					}
				},

				getIsFollowSet: function(topicId) {
					var res = 0;
					var that=this;
					$.ajax({
						url: domainUrl + "api/Topic/getIsSetFollow",
						type: 'get',
						dataType: "json",
						async: false,
						data: {
							UserName: that.UserName,
							TopicId: topicId
						},
						success: function(data) {
							if(data.code == "200") {
								if(data.isHave >= "1") {
									res = '1';
								}
							}
						},
						error: function() {
							plus.nativeUI.toast("网络错误，请稍后再试");
						}
					})

					return res;

				},

				SetFollowPost: function(topicId) {
					var res = this.getIsFollowSet(topicId);
					if(res == '0') {
						var that=this;
						$.ajax({
							url: domainUrl + "api/Topic/GetTopicSetFollow",
							type: 'get',
							dataType: "json",
							data: {
								UserName: that.UserName,
								TopicId: topicId
							},
							success: function(data) {
								if(data.code == "200") {
									plus.nativeUI.toast("关注成功");
								}
							},
							error: function() {
								plus.nativeUI.toast("网络错误，请稍后再试");
							}
						})
					} else {
						plus.nativeUI.toast("已关注");
					}
				},
				
				PowerCardActive: function(goid) {
						if(this.CardPowerActive == 0) {

							hui.confirm('您没有权限,需要激活服务卡？', ['取消', '确定'], function() {
								clicked('mall/MyPowerCardCount.html', 'MyPowerCardCount.html', 'slide-in-left', '健康服务卡');
							});

						} else {
							if(goid == 1) {
								clicked('member/MemberDataIndex.html', 'MemberDataIndex.html', 'slide-in-left', '健康数据');
							}
							if(goid == 2) {
								clicked('member/UploadCaseFiles.html', 'UploadCaseFiles.html', 'slide-in-left', '病历上传');
							}
							if(goid == 3) {
								clicked('member/DeviceList.html', 'DeviceList.html', 'slide-in-left', '监测设备绑定');
							}
							if(goid == 4) {
								clicked('member/MyReportIndex.html', 'MyReportIndex.html', 'zoom-fade-out', '健康评估报告');
							}
							if(goid == 5) {
								clicked('member/MyProjectRecord.html', 'MyProjectRecord.html', 'zoom-fade-out', '健康方案');
							}
						}
					},


				ShowNewsContent: function(id) {
					var parm = {
						"NewsId": id
					}
					clickedParm('member/ArticleContent.html', 'ArticleContent.html', 'slide-in-right', parm, '资讯详情');
				},
				ShowTopicContent: function(id) {
					var parm = {
						"TopicId": id
					}
					clickedParm('member/TopicContent.html', 'TopicContent.html', 'zoom-fade-out', parm, '健康话题');
				}

			}

		});
	</script>

</html>